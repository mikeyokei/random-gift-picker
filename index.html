<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Gift Picker with Redraw</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        h1, h2 {
            color: #333;
        }
        #giftDisplay, #redrawGiftDisplay {
            font-size: 18px;
            margin: 20px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            min-height: 50px;
        }
        input, button {
            font-size: 16px;
            padding: 10px;
            margin: 10px 0;
            width: calc(100% - 22px);
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #giftStatus, #redrawGiftStatus {
            margin-top: 20px;
            text-align: left;
        }
        #giftStatus ul, #redrawGiftStatus ul {
            list-style-type: none;
            padding: 0;
        }
        #giftStatus li, #redrawGiftStatus li {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        #feedback {
            color: #ff0000;
            margin-top: 10px;
        }
        .section {
            border-top: 1px solid #ddd;
            margin-top: 20px;
            padding-top: 20px;
        }
        #redrawButton {
            background-color: #2196F3;
        }
        #redrawButton:hover {
            background-color: #1976D2;
        }
        #adminSection {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        #resetButton, #resetRedrawButton {
            background-color: #f44336;
        }
        #resetButton:hover, #resetRedrawButton:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Random Gift Picker</h1>
        <input type="text" id="nameInput" placeholder="Enter your name" required aria-label="Your name">
        <div id="giftDisplay" aria-live="polite">Enter your name and click the button to pick a random gift!</div>
        <button id="pickButton" aria-label="Pick a Gift">Pick a Gift</button>
        <div id="feedback" aria-live="assertive"></div>
        <div id="giftStatus">
            <h2>Gift Status</h2>
            <ul id="giftStatusList" aria-label="List of picked gifts"></ul>
        </div>

        <div class="section">
            <h2>Redraw Section</h2>
            <input type="text" id="redrawNameInput" placeholder="Enter your name for redraw" required aria-label="Your name for redraw">
            <div id="redrawGiftDisplay" aria-live="polite">Enter your name and click the button to redraw a gift!</div>
            <button id="redrawButton" aria-label="Redraw a Gift">Redraw a Gift</button>
            <div id="redrawGiftStatus">
                <h3>Redrawn Gift Status</h3>
                <ul id="redrawGiftStatusList" aria-label="List of redrawn gifts"></ul>
            </div>
        </div>

        <div class="section">
            <h2>Admin Section</h2>
            <input type="password" id="adminPassword" placeholder="Enter admin password" aria-label="Admin password">
            <button id="adminLogin">Login as Admin</button>
            <div id="adminSection">
                <button id="resetButton" aria-label="Reset All Gift Status">Reset All Gift Status</button>
                <button id="resetRedrawButton" aria-label="Reset Redraw Gift Status">Reset Redraw Gift Status</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, push, get, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB1QTxxpjHrDzCsQj23rFxA7rQXcgwqgiU",
            authDomain: "gift-randomizer.firebaseapp.com",
            projectId: "gift-randomizer",
            storageBucket: "gift-randomizer.appspot.com",
            messagingSenderId: "1056233098101",
            appId: "1:1056233098101:web:b2b228a1593d6c2aebe13c",
            measurementId: "G-HPQ9C898SW",
            databaseURL: "https://gift-randomizer-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        signInAnonymously(auth).catch((error) => {
            console.error("Error signing in anonymously:", error);
            showFeedback("An error occurred. Please try again later.");
        });

        const gifts = [
            "Túi Labubu Blind Box",
            "Kẹp giấy Labubu Blind Box",
            "Đồ kẹp polaroid Candy Bear",
            "Miffy 10cm",
            "Miffy Móc chìa khóa",
            "CryBaby Flower Blind Box",
            "Mền tiên cá ariel disney",
            "Poster Brat (fan-made)",
            "Sổ VanGogh Museum",
            "Sổ claude monet",
            "2 tách trà gốm",
            "Labubu Louvre nam châm Blind Box",
            "Molly nam châm blind box"
        ];

        const redrawGifts = [
            "Kẹp giấy Labubu Blind Box",
            "Miffy Móc chìa khóa",
            "Mền tiên cá ariel disney",
            "Poster Brat (fan-made)",
            "Sổ VanGogh Museum",
            "Sổ claude monet",
            "2 tách trà gốm"
        ];

        async function pickRandomGift() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                showFeedback('Please enter your name first!');
                return;
            }

            if (localStorage.getItem('giftPicked')) {
                showFeedback('You have already picked a gift!');
                return;
            }

            try {
                const pickedGiftsRef = ref(database, 'pickedGifts');
                const snapshot = await get(pickedGiftsRef);
                const pickedGifts = snapshot.val() || {};

                const availableGifts = gifts.filter(gift => !Object.values(pickedGifts).some(picked => picked.gift === gift));

                if (availableGifts.length === 0) {
                    showFeedback('Sorry, all gifts have been picked!');
                    return;
                }

                const randomIndex = Math.floor(Math.random() * availableGifts.length);
                const selectedGift = availableGifts[randomIndex];
                const result = `${name} receives ${selectedGift}`;

                await push(pickedGiftsRef, { name: name, gift: selectedGift });

                document.getElementById('giftDisplay').textContent = result;
                localStorage.setItem('giftPicked', 'true');
                localStorage.setItem('selectedGift', result);
                document.getElementById('pickButton').disabled = true;
                document.getElementById('nameInput').disabled = true;
                showFeedback('Gift picked successfully!', 'green');
            } catch (error) {
                console.error("Error picking gift:", error);
                showFeedback('An error occurred. Please try again.');
            }
        }

       async function redrawGift() {
            const name = document.getElementById('redrawNameInput').value.trim();
            if (!name) {
                showFeedback('Please enter your name for redraw!');
                return;
            }

            try {
                const redrawGiftsRef = ref(database, 'redrawGifts');
                
                // First, try to read from the database
                let snapshot;
                try {
                    snapshot = await get(redrawGiftsRef);
                } catch (readError) {
                    console.error("Error reading from database:", readError);
                    showFeedback('Unable to access the gift database. Please contact the administrator.');
                    return;
                }

                const pickedRedrawGifts = snapshot.val() || {};

                const availableRedrawGifts = redrawGifts.filter(gift => !Object.values(pickedRedrawGifts).some(picked => picked.gift === gift));

                if (availableRedrawGifts.length === 0) {
                    showFeedback('Sorry, all redraw gifts have been picked!');
                    return;
                }

                const randomIndex = Math.floor(Math.random() * availableRedrawGifts.length);
                const selectedGift = availableRedrawGifts[randomIndex];
                const result = `${name} redraws ${selectedGift}`;

                // Try to write to the database
                try {
                    await push(redrawGiftsRef, { name: name, gift: selectedGift });
                } catch (writeError) {
                    console.error("Error writing to database:", writeError);
                    showFeedback('Unable to save your gift selection. Please contact the administrator.');
                    return;
                }

                document.getElementById('redrawGiftDisplay').textContent = result;
                document.getElementById('redrawButton').disabled = true;
                document.getElementById('redrawNameInput').disabled = true;
                showFeedback('Gift redrawn successfully!', 'green');
            } catch (error) {
                console.error("Error redrawing gift:", error);
                showFeedback('An unexpected error occurred. Please try again or contact the administrator.');
            }
        }

        function updateGiftStatus(pickedGifts, elementId) {
            const giftStatusList = document.getElementById(elementId);
            giftStatusList.innerHTML = '';
            
            for (const [key, value] of Object.entries(pickedGifts)) {
                const listItem = document.createElement('li');
                listItem.textContent = `${value.name} received ${value.gift}`;
                giftStatusList.appendChild(listItem);
            }
        }

        function showFeedback(message, color = 'red') {
            const feedbackElement = document.getElementById('feedback');
            feedbackElement.textContent = message;
            feedbackElement.style.color = color;
            setTimeout(() => {
                feedbackElement.textContent = '';
            }, 5000);
        }

        async function resetAllGiftStatus() {
            try {
                await set(ref(database, 'pickedGifts'), null);
                await set(ref(database, 'redrawGifts'), null);
                showFeedback('All gift status reset successfully!', 'green');
                document.getElementById('giftDisplay').textContent = '';
                document.getElementById('redrawGiftDisplay').textContent = '';
                document.getElementById('pickButton').disabled = false;
                document.getElementById('nameInput').disabled = false;
                document.getElementById('redrawButton').disabled = false;
                document.getElementById('redrawNameInput').disabled = false;
                localStorage.removeItem('giftPicked');
                localStorage.removeItem('selectedGift');
            } catch (error) {
                console.error("Error resetting gift status:", error);
                showFeedback('An error occurred while resetting gift status.');
            }
        }

        async function resetRedrawGiftStatus() {
            try {
                await set(ref(database, 'redrawGifts'), null);
                showFeedback('Redraw gift status reset successfully!', 'green');
                document.getElementById('redrawGiftDisplay').textContent = '';
                document.getElementById('redrawButton').disabled = false;
                document.getElementById('redrawNameInput').disabled = false;
            } catch (error) {
                console.error("Error resetting redraw gift status:", error);
                showFeedback('An error occurred while resetting redraw gift status.');
            }
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'your_admin_password_here') {
                document.getElementById('adminSection').style.display = 'block';
                showFeedback('Admin login successful', 'green');
            } else {
                showFeedback('Incorrect admin password');
            }
        }

        window.onload = function() {
            if (localStorage.getItem('giftPicked')) {
                const savedResult = localStorage.getItem('selectedGift');
                document.getElementById('giftDisplay').textContent = savedResult;
                document.getElementById('pickButton').disabled = true;
                document.getElementById('nameInput').disabled = true;
            }

            const pickedGiftsRef = ref(database, 'pickedGifts');
            onValue(pickedGiftsRef, (snapshot) => {
                const pickedGifts = snapshot.val() || {};
                updateGiftStatus(pickedGifts, 'giftStatusList');
            });

            const redrawGiftsRef = ref(database, 'redrawGifts');
            onValue(redrawGiftsRef, (snapshot) => {
                const pickedRedrawGifts = snapshot.val() || {};
                updateGiftStatus(pickedRedrawGifts, 'redrawGiftStatusList');
            });
        }

        document.getElementById('pickButton').addEventListener('click', pickRandomGift);
        document.getElementById('redrawButton').addEventListener('click', redrawGift);
        document.getElementById('adminLogin').addEventListener('click', checkAdminPassword);
        document.getElementById('resetButton').addEventListener('click', resetAllGiftStatus);
        document.getElementById('resetRedrawButton').addEventListener('click', resetRedrawGiftStatus);
    </script>
</body>
</html>
